package group.assignment.booking_hotel_backend.services.impl;

import group.assignment.booking_hotel_backend.dto.BookingSearchRequest;
import group.assignment.booking_hotel_backend.dto.BookingSearchResponse;
import group.assignment.booking_hotel_backend.models.Booking;
import group.assignment.booking_hotel_backend.models.Hotel;
import group.assignment.booking_hotel_backend.models.Room;
import group.assignment.booking_hotel_backend.models.Service;
import group.assignment.booking_hotel_backend.repository.BookingRepository;
import group.assignment.booking_hotel_backend.repository.HotelRepository;
import group.assignment.booking_hotel_backend.repository.RoomRepository;
import group.assignment.booking_hotel_backend.services.BookingService;
import lombok.RequiredArgsConstructor;

import java.time.Duration;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.stream.Collectors;

@org.springframework.stereotype.Service
@RequiredArgsConstructor
public class BookingServiceImpl implements BookingService {
    private final HotelRepository hotelRepository;
    private final RoomRepository roomRepository;
    private final BookingRepository bookingRepository;
    @Override
    public List<BookingSearchResponse> searchAvailableRooms(BookingSearchRequest request) {
        List<Hotel> hotels = hotelRepository.findByAddressCityAndAddressDistrict(
                request.getCity(), request.getDistrict()
        );
        System.out.println("1");
        for (Hotel hotel : hotels) {
            System.out.println(hotel.getHotelName());
        }

        List<BookingSearchResponse> results = new ArrayList<>();

        LocalDateTime checkIn = parseDateTime(request.getCheckInDate(), request.getCheckInTime());
        LocalDateTime checkOut = parseDateTime(request.getCheckOutDate(), request.getCheckOutTime());

        for (Hotel hotel : hotels) {
            for (Room room : hotel.getRoomList()) {
                // 2. Lọc dịch vụ theo yêu cầu
                List<String> roomServiceNames = room.getServiceList().stream()
                        .map(Service::getServiceName)
                        .collect(Collectors.toList());

                if (request.getServices() != null && !roomServiceNames.containsAll(request.getServices())) {
                    continue;
                }
                if(request.getAdults() + request.getChildren() > room.getMaxOccupancy()){
                    continue;
                }
                System.out.println("2");
                for (String serviceName : request.getServices()) {
                    System.out.println(serviceName);
                }


                // 3. Kiểm tra xem phòng có bị trùng lịch không

                boolean isAvailable = isAvailable(room, checkIn, checkOut);
                if (!isAvailable) continue;

                System.out.println(3);
                System.out.println(isAvailable);


                // 4. Tính tổng giá tiền
                double price = calculateTotalPrice(request, room);
                System.out.println(4);
                System.out.println(price);

                // 5. Lọc theo khoảng giá
                if (request.getPriceFrom() != null && price < request.getPriceFrom()) continue;
                if (request.getPriceTo() != null && price > request.getPriceTo()) continue;
                System.out.println(5);

                results.add(BookingSearchResponse.builder()
                        .roomId(room.getRoomId())
                        .roomName(room.getRoomName())
                        .price(price)
                        .hotelName(hotel.getHotelName())
                        .address(hotel.getAddress().getSpecificAddress())
                        .services(roomServiceNames)
                        .build());
            }
        }

        System.out.println(6);
        System.out.println(results.size());

        // 6. Sắp xếp
        Comparator<BookingSearchResponse> comparator = Comparator.comparing(BookingSearchResponse::getPrice);
        if ("price_desc".equals(request.getSortBy())) {
            comparator = comparator.reversed();
        }

        results.sort(comparator);
        return results;
    }

    private LocalDateTime parseDateTime(String date, String time) {
        String dateTimeString = date + " " + time;
        return LocalDateTime.parse(dateTimeString, DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"));
    }

    public boolean isAvailable(Room room, LocalDateTime checkIn, LocalDateTime checkOut) {
        List<Booking> existingBookings = bookingRepository
                .findByRoomRoomIdAndCheckOutAfterAndCheckInBefore(
                        room.getRoomId(), checkIn.minusHours(1), checkOut.plusHours(1)
                );
        for (Booking existingBooking : existingBookings) {
            if (!(checkOut.isBefore(existingBooking.getCheckIn()) || checkIn.isAfter(existingBooking.getCheckOut()))) {
                return false;
            }
        }
        return true;
    }

    private double calculateTotalPrice(BookingSearchRequest request, Room room) {
        Double pricePerNight = room.getPricePerNight();
        Double comboPriceFor2Hours = room.getComboPrice2h();
        Double extraHourRate = room.getExtraHourPrice();
        Double extraAdultRate = room.getExtraAdult();
        int freeChildrenCount = room.getNumChildrenFree();
        int standardOccupancy = room.getStandardOccupancy();

        Double extraCharges = 0D;
        long additionalPeopleCount = 0;

        if (request.getAdults() > standardOccupancy) {
            additionalPeopleCount = request.getAdults() - standardOccupancy;
        }
        if (request.getChildren() > freeChildrenCount) {
            additionalPeopleCount += request.getChildren() - freeChildrenCount;
        }

        extraCharges = additionalPeopleCount * extraAdultRate;

        String checkInDateTime = request.getCheckInDate() + " " + request.getCheckInTime() + ":00";
        String checkOutDateTime = request.getCheckOutDate() + " " + request.getCheckOutTime() + ":00";
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
        LocalDateTime checkInDateTimeParsed = LocalDateTime.parse(checkInDateTime, formatter);
        LocalDateTime checkOutDateTimeParsed = LocalDateTime.parse(checkOutDateTime, formatter);

        LocalDateTime standardCheckInTime = LocalDateTime.of(checkInDateTimeParsed.toLocalDate(), LocalTime.of(14, 0));
        LocalDateTime standardCheckOutTime = LocalDateTime.of(checkOutDateTimeParsed.toLocalDate(), LocalTime.of(11, 0));

        if (checkInDateTimeParsed.isBefore(standardCheckInTime)) {
            standardCheckInTime = standardCheckInTime.minusDays(1);
        }

        LocalDateTime nextCheckInTime = standardCheckInTime.plusDays(1);
        long earlyCheckInHours = ChronoUnit.HOURS.between(checkInDateTimeParsed, nextCheckInTime);
        if (earlyCheckInHours < 0) earlyCheckInHours = 0;

        long lateCheckOutHours = ChronoUnit.HOURS.between(standardCheckOutTime, checkOutDateTimeParsed);
        if (lateCheckOutHours < 0) lateCheckOutHours = 0;

        if (earlyCheckInHours >= 24) {
            earlyCheckInHours -= 24;
        }

        long totalStayDurationInDays = ChronoUnit.DAYS.between(checkInDateTimeParsed.minusDays(1), standardCheckOutTime);
        Double totalStayPrice = (Double) (totalStayDurationInDays * pricePerNight + (earlyCheckInHours + lateCheckOutHours) * extraHourRate + extraCharges);

        long totalDurationInHours = ChronoUnit.HOURS.between(checkInDateTimeParsed, checkOutDateTimeParsed);
        Double timeBasedPrice = 0D;

        if (totalDurationInHours >= 2) {
            timeBasedPrice = comboPriceFor2Hours + extraHourRate * (totalDurationInHours - 2);
        } else if (totalDurationInHours == 1) {
            timeBasedPrice = comboPriceFor2Hours;
        }

        timeBasedPrice += extraCharges;

        return Math.min(totalStayPrice, timeBasedPrice);
    }




//    private double calculateTotalPrice(BookingSearchRequest request, Room room) {
//        double pricePerNight = room.getPricePerNight();
//        double extraHourPrice = room.getExtraHourPrice();
//        double extraAdult = room.getExtraAdult();
//        int numChildrenFree = room.getNumChildrenFree();
//        int standardOccupancy = room.getStandardOccupancy();
//
//        double priceExtra = 0;
//        int numAdults = request.getAdults();
//        int numChildren = request.getChildren();
//
//        if (numAdults > standardOccupancy) {
//            priceExtra += (numAdults - standardOccupancy) * extraAdult;
//        }
//        if (numChildren > numChildrenFree) {
//            priceExtra += (numChildren - numChildrenFree) * extraAdult;
//        }
//
//        String checkInDateTime = request.getCheckInDate() + " " + request.getCheckInTime() + ":00";
//        String checkOutDateTime = request.getCheckOutDate() + " " + request.getCheckOutTime() + ":00";
//        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
//        LocalDateTime checkInTime = LocalDateTime.parse(checkInDateTime, formatter);
//        LocalDateTime checkOutTime = LocalDateTime.parse(checkOutDateTime, formatter);
//        LocalDateTime standardCheckIn = LocalDateTime.of(checkInTime.toLocalDate(), LocalTime.of(14, 0));
//        LocalDateTime standardCheckOut = LocalDateTime.of(checkOutTime.toLocalDate(), LocalTime.of(11, 0));
//
//
//
//        long earlyCheckInHours = ChronoUnit.HOURS.between(checkInTime, standardCheckIn);
//        if (earlyCheckInHours < 0) earlyCheckInHours = 0;
//        long lateCheckOutHours = ChronoUnit.HOURS.between(standardCheckOut, checkOutTime);
//        if (lateCheckOutHours < 0) lateCheckOutHours = 0;
//
//        long totalDays = ChronoUnit.DAYS.between(checkInTime, checkOutTime);
//        double totalPrice = totalDays * pricePerNight + (earlyCheckInHours + lateCheckOutHours) * extraHourPrice + priceExtra;
//
//        long totalComboHours = ChronoUnit.HOURS.between(checkInTime, checkOutTime);
//        double comboPrice = 0;
//
//        if (totalComboHours >= 2) {
//            comboPrice = room.getComboPrice2h() + extraHourPrice * (totalComboHours - 2);
//        } else if (totalComboHours == 1) {
//            comboPrice = room.getComboPrice2h();
//        }
//
//        double finalPrice = Math.min(totalPrice, comboPrice + priceExtra);
//
//        return finalPrice;
//    }

}
